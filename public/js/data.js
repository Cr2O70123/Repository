const CONFIG = {
    ELIXIR_RATE: 0.018, MAX_ELIXIR: 10, GAME_TIME: 180, DBL_ELIXIR: 60,
    RIVER_OFF: 0.5, BRIDGE_W: 60,
    COLORS: { P: '#3498db', E: '#e74c3c', GRASS: '#27ae60', WATER: '#48dbfb' }
};

const CARDS = {
    knight: { id: 'knight', name: 'é¨Žå£«', desc: 'è¿‘æˆ°å¦å…‹', cost: 3, count: 1, hp: 1400, dmg: 130, speed: 0.35, range: 0, atkSpd: 65, type: 'ground', target: 'any', icon: 'âš”ï¸', radius: 16, mass: 6.0, deployTime: 60, rarity: 'common' },
    archer: { id: 'archer', name: 'å¼“ç®­æ‰‹', desc: 'é ç¨‹è¼¸å‡º', cost: 3, count: 2, hp: 350, dmg: 80, speed: 0.4, range: 110, atkSpd: 50, type: 'ground', target: 'any', icon: 'ðŸ¹', radius: 12, mass: 1.5, deployTime: 60, rarity: 'common' },
    musketeer: { id: 'musketeer', name: 'ç«æ§æ‰‹', desc: 'é ç¨‹å–®é«”', cost: 4, count: 1, hp: 600, dmg: 180, speed: 0.35, range: 140, atkSpd: 60, type: 'ground', target: 'any', icon: 'ðŸ‘’', radius: 14, mass: 2.0, deployTime: 60, rarity: 'rare' },
    giant: { id: 'giant', name: 'å·¨äºº', desc: 'åªæ‰“å»ºç¯‰', cost: 5, count: 1, hp: 3500, dmg: 250, speed: 0.2, range: 0, atkSpd: 120, type: 'ground', target: 'building', icon: 'ðŸ¦', radius: 28, mass: 30.0, deployTime: 120, rarity: 'rare' },
    prince: { id: 'prince', name: 'çŽ‹å­', desc: 'è¡é‹’é›™å€', cost: 5, count: 1, hp: 1600, dmg: 325, speed: 0.35, range: 0, atkSpd: 80, type: 'ground', target: 'any', icon: 'ðŸŽ', radius: 18, mass: 8.0, deployTime: 60, chargeSpeed: 0.75, chargeDmgMult: 2.0, rarity: 'epic' },
    skarmy: { id: 'skarmy', name: 'éª·é«è»åœ˜', desc: 'äººæµ·æˆ°è¡“', cost: 3, count: 5, hp: 60, dmg: 40, speed: 0.55, range: 0, atkSpd: 30, type: 'ground', target: 'any', icon: 'ðŸ’€', radius: 8, mass: 0.5, deployTime: 30, rarity: 'epic' },
    wizard: { id: 'wizard', name: 'æ³•å¸«', desc: 'ç¯„åœå‚·å®³', cost: 5, count: 1, hp: 700, dmg: 180, speed: 0.3, range: 120, atkSpd: 90, type: 'ground', target: 'any', icon: 'ðŸ§™â€â™‚ï¸', aoe: 60, radius: 14, mass: 2.5, deployTime: 60, rarity: 'rare' },
    bats: { id: 'bats', name: 'è™è ', desc: 'ç©ºä¸­ç¾¤é«”', cost: 2, count: 4, hp: 50, dmg: 50, speed: 0.7, range: 0, atkSpd: 25, type: 'air', target: 'any', icon: 'ðŸ¦‡', radius: 8, mass: 0.5, deployTime: 30, rarity: 'common' },
    minipekka: { id: 'minipekka', name: 'è¿·ä½ çš®å¡', desc: 'é«˜å‚·å–®é«”', cost: 4, count: 1, hp: 1100, dmg: 550, speed: 0.55, range: 0, atkSpd: 95, type: 'ground', target: 'any', icon: 'ðŸ¤–', radius: 16, mass: 5.0, deployTime: 60, rarity: 'rare' },
    hogrider: { id: 'hogrider', name: 'é‡Žè±¬é¨Žå£«', desc: 'å¿«é€Ÿçªæ“Š', cost: 4, count: 1, hp: 1400, dmg: 260, speed: 0.8, range: 0, atkSpd: 70, type: 'ground', target: 'building', icon: 'ðŸ·', radius: 18, mass: 5.0, deployTime: 60, rarity: 'rare' },
    babydragon: { id: 'babydragon', name: 'é£›é¾å¯¶å¯¶', desc: 'ç©ºä¸­ç¯„åœ', cost: 4, count: 1, hp: 1000, dmg: 130, speed: 0.45, range: 90, atkSpd: 80, type: 'air', target: 'any', icon: 'ðŸ²', aoe: 50, radius: 16, mass: 4.0, deployTime: 60, rarity: 'epic' },
    golem: { id: 'golem', name: 'æˆˆå´™çŸ³äºº', desc: 'ç©¶æ¥µè‚‰ç›¾', cost: 8, count: 1, hp: 4500, dmg: 280, speed: 0.15, range: 0, atkSpd: 140, type: 'ground', target: 'building', icon: 'ðŸ—¿', radius: 32, mass: 50.0, deployTime: 180, deathDmg: 300, rarity: 'legendary' },
    fireball: { id: 'fireball', name: 'ç«çƒè¡“', desc: 'å€åŸŸæ³•è¡“', cost: 4, count: 1, hp: 0, dmg: 350, speed: 0, range: 0, atkSpd: 0, type: 'spell', target: 'any', icon: 'ðŸ”¥', aoe: 110, knockback: 8, rarity: 'rare' },
    zap: { id: 'zap', name: 'é›»æ“Šæ³•è¡“', desc: 'ä½Žè²»æšˆçœ©', cost: 2, count: 1, hp: 0, dmg: 70, speed: 0, range: 0, atkSpd: 0, type: 'spell', target: 'any', icon: 'âš¡', aoe: 80, stun: 60, rarity: 'common' },
    barrel: { id: 'barrel', name: 'å“¥å¸ƒæž—é£›æ¡¶', desc: 'å…¨åœ–å·è¥²', cost: 3, count: 1, hp: 0, dmg: 50, speed: 0, range: 0, atkSpd: 0, type: 'spell', target: 'any', icon: 'ðŸ›¢ï¸', spawnUnit: 'goblins', knockback: 0, rarity: 'epic' },
    cannon: { id: 'cannon', name: 'åŠ è¾²ç ²', desc: 'é˜²ç¦¦å»ºç¯‰', cost: 3, count: 1, hp: 800, dmg: 100, speed: 0, range: 120, atkSpd: 60, type: 'building', target: 'any', icon: 'âš™ï¸', radius: 20, mass: 100, lifeTime: 1800, deployTime: 180, rarity: 'common' },
    goblins: { id: 'goblins', name: 'å“¥å¸ƒæž—', cost: 2, count: 3, hp: 180, dmg: 90, speed: 0.65, range: 0, atkSpd: 35, type: 'ground', target: 'any', icon: 'ðŸ‘º', radius: 10, mass: 0.8, deployTime: 10, rarity: 'common' }
};
const ALL_CARDS = Object.keys(CARDS).filter(k => k !== 'goblins');
const RECOMMENDED_CARDS = ['knight', 'archer', 'giant', 'fireball', 'musketeer', 'minipekka', 'babydragon'];
const RANDOM_NAMES = ['é¦™ç”œè‰èŽ“','ç‹‚æš´é‡Žè±¬','ç„¡æ•µç ´å£žçŽ‹','é–ƒé›»æ³•å¸«','çš‡å®¶é¨Žå£«','æ·˜æ°£å“¥å¸ƒæž—','å¤œå¹•æ®ºæ‰‹','æ¦®è€€çŽ‹è€…'];

const SHOP_ITEMS = [
    { id: 'prince', type: 'card', val: 'prince', price: 1000, name: 'çŽ‹å­' },
    { id: 'golem', type: 'card', val: 'golem', price: 2000, name: 'æˆˆå´™çŸ³äºº' },
    { id: 'emote_1', type: 'emote', val: 'ðŸ˜Ž', price: 200, name: 'å¢¨é¡è¡¨æƒ…' }
];

const AudioSys={ctx:null,init:function(){window.AudioContext=window.AudioContext||window.webkitAudioContext;this.ctx=new AudioContext},play:function(t){if(!this.ctx)return;const e=this.ctx.currentTime,n=this.ctx.createOscillator(),o=this.ctx.createGain();o.connect(this.ctx.destination),n.connect(o),"spawn"===t?(n.frequency.setValueAtTime(300,e),n.frequency.exponentialRampToValueAtTime(50,e+.2),o.gain.setValueAtTime(.1,e),o.gain.exponentialRampToValueAtTime(.01,e+.2),n.start(),n.stop(e+.2)):"attack"===t?(n.type="triangle",n.frequency.setValueAtTime(150,e),n.frequency.linearRampToValueAtTime(100,e+.05),o.gain.setValueAtTime(.05,e),o.gain.linearRampToValueAtTime(0,e+.05),n.start(),n.stop(e+.05)):"charge_hit"===t?(n.type="sawtooth",n.frequency.setValueAtTime(200,e),n.frequency.exponentialRampToValueAtTime(50,e+.3),o.gain.setValueAtTime(.15,e),o.gain.exponentialRampToValueAtTime(.01,e+.3),n.start(),n.stop(e+.3)):"zap"===t?(n.type="sawtooth",n.frequency.setValueAtTime(800,e),n.frequency.linearRampToValueAtTime(200,e+.15),o.gain.setValueAtTime(.1,e),o.gain.linearRampToValueAtTime(0,e+.15),n.start(),n.stop(e+.15)):"heavy_hit"===t?(n.type="square",n.frequency.setValueAtTime(80,e),n.frequency.exponentialRampToValueAtTime(20,e+.15),o.gain.setValueAtTime(.2,e),o.gain.exponentialRampToValueAtTime(.01,e+.15),n.start(),n.stop(e+.15)):"double_elixir"===t?(n.type="sine",n.frequency.setValueAtTime(440,e),n.frequency.linearRampToValueAtTime(880,e+.5),o.gain.setValueAtTime(.1,e),o.gain.linearRampToValueAtTime(0,e+.5),n.start(),n.stop(e+.5)):"ui"===t?(n.frequency.setValueAtTime(800,e),o.gain.setValueAtTime(.05,e),o.gain.exponentialRampToValueAtTime(.01,e+.1),n.start(),n.stop(e+.1)):"boom"===t&&(n.type="sawtooth",n.frequency.setValueAtTime(120,e),n.frequency.exponentialRampToValueAtTime(10,e+.4),o.gain.setValueAtTime(.2,e),o.gain.exponentialRampToValueAtTime(.01,e+.4),n.start(),n.stop(e+.4))}};
class Vector2 { constructor(x,y){this.x=x;this.y=y;} add(v){this.x+=v.x;this.y+=v.y;return this;} sub(v){this.x-=v.x;this.y-=v.y;return this;} mult(n){this.x*=n;this.y*=n;return this;} mag(){return Math.sqrt(this.x*this.x+this.y*this.y);} normalize(){let m=this.mag();if(m>0)this.mult(1/m);return this;} dist(v){return Math.hypot(this.x-v.x,this.y-v.y);} copy(){return new Vector2(this.x,this.y);}}
class ParticlePool { constructor(){this.pool=[];this.maxSize=200;} get(x,y,color,type,val){let p=this.pool.find(p=>!p.active);if(!p){if(this.pool.length<this.maxSize){p=new Particle();this.pool.push(p);}else return null;}p.reset(x,y,color,type,val);return p;} updateAndDraw(ctx){this.pool.forEach(p=>{if(p.active){p.update();p.draw(ctx);}});} clear(){this.pool.forEach(p=>p.active=false);} }
class Particle { constructor(){this.active=false;this.pos=new Vector2(0,0);this.vel=new Vector2(0,0);} reset(x,y,c,t,v){this.active=true;this.pos.x=x;this.pos.y=y;this.type=t;this.color=c;this.life=1.0; if(t==='text'||t==='crit'){this.text=v+(t==='crit'?"!":"");this.scale=t==='crit'?2.5:Math.min(2,0.8+v/200);this.vel=new Vector2((Math.random()-0.5),t==='crit'?-3:-2.5);this.decay=0.02;}else if(t==='spawn_flash'){this.vel=new Vector2(0,0);this.decay=0.08;this.size=10;}else if(t==='emote'){this.text=v;this.vel=new Vector2(0,-0.8);this.decay=0.01;this.life=2.5;}else if(t==='water_ripple'){this.vel=new Vector2(0.5,0);this.decay=0.01;this.size=Math.random()*5+2;}else{this.vel=new Vector2((Math.random()-0.5)*3,(Math.random()-0.5)*3);this.decay=0.05;this.size=Math.random()*4+2;}} update(){this.pos.add(this.vel);this.life-=this.decay;if(this.life<=0)this.active=false;if(this.type==='spawn_flash')this.size+=2;} draw(ctx){if(!this.active)return;ctx.globalAlpha=Math.max(0,this.life); if(this.type==='text'||this.type==='crit'){ctx.save();ctx.translate(this.pos.x,this.pos.y);ctx.scale(this.scale,this.scale);ctx.font="900 16px sans-serif";ctx.textAlign="center";ctx.fillStyle=this.color;ctx.strokeStyle='#000';ctx.lineWidth=3;ctx.strokeText(this.text,0,0);ctx.fillText(this.text,0,0);ctx.restore();}else if(this.type==='emote'){ctx.font="24px sans-serif";ctx.textAlign="center";ctx.fillStyle='black';ctx.fillText(this.text,this.pos.x,this.pos.y-20);}else if(this.type==='spawn_flash'){ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.size,0,Math.PI*2);ctx.fill();}else if(this.type==='water_ripple'){ctx.strokeStyle='rgba(255,255,255,0.4)';ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.size,0,Math.PI*2);ctx.stroke();}else{ctx.fillStyle=this.color;ctx.beginPath();ctx.arc(this.pos.x,this.pos.y,this.size,0,Math.PI*2);ctx.fill();} ctx.globalAlpha=1;} }